<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mix Dashboard</title>
  <style>
    body { font-family: sans-serif; padding:20px; background:#f6f7fb; }
    .controls { background:#fff; padding:12px; border:1px solid #ddd; display:inline-block; vertical-align:top; }
    .output { display:inline-block; margin-left:20px; vertical-align:top; }
    button { margin-top:8px; padding:8px 12px; }
    .warning { background:#fff3cd; padding:10px; border:1px solid #ffeeba; }
  </style>
</head>
<body>
  <h1>Mix Dashboard</h1>
  <div class="controls">
    <h3>Weights</h3>
    <form id="weightsForm">
      <label style="display:block;margin:6px 0;"><strong>SOLUSDT</strong> <input type="number" step="0.01" name="SOLUSDT" value="1.0000" style="width:120px;"></label>
<label style="display:block;margin:6px 0;"><strong>DOGEUSDT</strong> <input type="number" step="0.01" name="DOGEUSDT" value="1.0000" style="width:120px;"></label>
<label style="display:block;margin:6px 0;"><strong>BNBUSDT</strong> <input type="number" step="0.01" name="BNBUSDT" value="1.0000" style="width:120px;"></label>
<label style="display:block;margin:6px 0;"><strong>ETHUSDT</strong> <input type="number" step="0.01" name="ETHUSDT" value="1.0000" style="width:120px;"></label>
<label style="display:block;margin:6px 0;"><strong>XRPUSDT</strong> <input type="number" step="0.01" name="XRPUSDT" value="1.0000" style="width:120px;"></label>
      <div>
        <button type="button" onclick="computeMix()">محاسبه ترکیب</button>
        <button type="button" onclick="saveMix()">ذخیره ترکیب</button>
        <button type="button" onclick="saveMixServer()">ذخیره سروری</button>
      </div>
    </form>
  </div>
  <div class="output">
    <h3>نتایج</h3>
    <div id="summary"></div>
    <img id="chart" src="mix_comparison.png" style="max-width:600px;border:1px solid #ccc;">
  </div>
  <script>
  const symbolData = {"SOLUSDT": [1.7839], "DOGEUSDT": [0.0023], "BNBUSDT": [21.2454], "ETHUSDT": [40.6081], "XRPUSDT": [0.0376]};
  function cumulative(arr){ let s=0; return arr.map(function(v){ s += v; return s; }); }
  function maxDrawdown(series){ var peak=-Infinity, m=0; for(var i=0;i<series.length;i++){ var v=series[i]; if(v>peak) peak=v; var d=peak-v; if(d>m) m=d; } return m; }
  function computeMix(){
    var form = document.getElementById('weightsForm');
    var fd = new FormData(form);
    var weights = {};
    var total = 0;
    for(var pair of fd.entries()){ var k=pair[0], v=parseFloat(pair[1])||0; weights[k]=v; total += Math.abs(v); }
    if(total===0){ for(var k in weights) weights[k]=1; total=Object.keys(weights).length; }
    for(var k in weights) weights[k] = weights[k]/total;
    var symbols = Object.keys(symbolData);
    var maxLen = 0;
    for(var i=0;i<symbols.length;i++){ if(symbolData[symbols[i]].length > maxLen) maxLen = symbolData[symbols[i]].length; }
    var comb = [];
    for(var i=0;i<maxLen;i++){
      var step = 0;
      for(var si=0; si<symbols.length; si++){
        var s = symbols[si];
        var v = (symbolData[s][i] !== undefined) ? symbolData[s][i] : 0;
        step += (weights[s] || 0) * v;
      }
      comb.push(step);
    }
    var cum = cumulative(comb);
    var profit = cum.length ? cum[cum.length-1] : 0;
    var dd = maxDrawdown(cum);
    document.getElementById('summary').innerHTML = '<div><strong>Total Profit</strong>: ' + profit.toFixed(4) + ' &nbsp; <strong>Max Drawdown</strong>: ' + dd.toFixed(4) + '</div>';
  }
  function saveMix(){
    var form = document.getElementById('weightsForm');
    var fd = new FormData(form);
    var mix = {};
    for(var pair of fd.entries()){ mix[pair[0]] = parseFloat(pair[1])||0; }
    var saved = JSON.parse(localStorage.getItem('saved_mixes')||'[]');
    saved.push({timestamp: Date.now(), weights: mix});
    localStorage.setItem('saved_mixes', JSON.stringify(saved));
    alert('ترکیب در localStorage ذخیره شد. برای ذخیره سروری، از دکمه ذخیره سروری استفاده کنید.');
  }
  function saveMixServer(){
    var form = document.getElementById('weightsForm');
    var fd = new FormData(form);
    var payload = {};
    for(var pair of fd.entries()){ payload[pair[0]] = parseFloat(pair[1])||0; }
    fetch('save_mix', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({timestamp: Date.now(), weights: payload}) })
      .then(function(r){ return r.json(); })
      .then(function(j){ alert('Server saved: ' + (j.ok? 'OK' : JSON.stringify(j))); })
      .catch(function(e){ alert('Server save failed: ' + e); });
  }
  </script>
</body>
</html>
